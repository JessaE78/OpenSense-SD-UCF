
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles_data.css">  

    <title>OpenSense Data Page</title>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>Open Sense Data Displaying</h1>
        </div>
        
        <!-- Top half container -->
        <div class="data-container">
            <div class="data-list" id="data-list"> 
                <!-- Data will be injected here -->
            </div>

            <div class="data-graph" id="graph-container">
                <!-- Graph will go here -->
            </div>
        </div>

        <div class="chart-info">
            <span>Sensor data</span>
            <span style="margin-left: 290px;">Graph</span>
        </div>

        <!-- Bottom half container -->
        <div class="button-container">
            <div class="sensor-buttons">
                <button class="sensor-button" id="startButton" >Start</button>
                <button class="sensor-button" id="stopButton" >Stop</button>
                <button class="sensor-button" id="sensor3" onclick="insertGraphImage()">Graph</button>
            </div>
            <div class="config-clear-buttons">
                <button class="clear-button" onclick="clearContent()">Clear</button>
                <button class="config-button" onclick="window.location.href = '/ ';">Return</button>
                <!-- <button class="config-button" onclick="window.location.href = 'index.html';">Return</button> -->
            </div>
        </div>
    </div>

    <script>
        var intervalId;
        var dataArray = [];
        var lastLine = '';

        function insertGraphImage() {
            var graphContainer = document.getElementById('graph-container');
            graphContainer.innerHTML = '<img src="graph.png">';
        }
    
        // Method to clear the content
        function clearContent() {
            clearInterval(intervalId);
            var dataContainer = document.getElementById('data-list');
            var graphContainer = document.getElementById('graph-container');
            dataContainer.innerHTML = '';
            graphContainer.innerHTML = '';
            dataArray = [];
            lastLine = '';
        }
        
        // Method to fetch data from file and inject it into the container
        // function injectDataFromFile(sensorId) {
        //     clearInterval(intervalId);

        //     var dataContainer = document.getElementById('data-list');
        //     dataContainer.innerHTML = '';

        //     fetch('data.txt')
        //         .then(response => response.text())
        //         .then(data => {
        //             const lines = data.split('\n');

        //             if (lines[lines.length - 1] !== lastLine) {
        //                 dataArray = lines.reverse();
        //                 lastLine = lines[lines.length - 1];
        //                 injectData(sensorId);
        //             }
        //         })
        //         .catch(error => console.error('Error fetching data:', error));
        // }
            
        // Method to inject data into the container
        // function injectData(sensorId) {
        //     intervalId = setInterval(function() {
        //         var dataContainer = document.getElementById('data-list');
    
        //         if (dataArray.length > 0) {
        //             // insert backwards for top down insertion
        //             var line = dataArray.pop();
        //             var parts = line.split(', ');
        //             var newData = document.createElement('p');
    
        //             switch(sensorId) {
        //             case 'sensor1':
        //                 newData.innerHTML = "<span class='data-spacing'>" + parts[0] + "</span>" + parts[1] + " °C";
        //                 break;
        //             case 'sensor2':
        //                 newData.innerHTML = "<span class='data-spacing'>" + parts[0] + "</span>" + parts[2] + " PPB";
        //                 break;
        //             case 'sensor3':
        //                 newData.innerHTML = "<span class='data-spacing'>" + parts[0] + "</span>" + parts[3] + " lux";
        //                 break;
        //             default:
        //                 newData.textContent = "error";
        //             }
    
        //             dataContainer.insertBefore(newData, dataContainer.firstChild);
        //         } else {
        //             clearInterval(intervalId);
        //             dataArray = [];
        //         }
        //     }, 1000);
        // }
        // function startFetchingData() {

        //     intervalId = setInterval(() => {
        //         fetch('/get-sensor-data')
        //             .then(response => response.json())
        //             .then(data => {
        //             // How the data should look using JSON: { "temperature": 24.5 }
        //             displayData(data);
        //             })
        //         .catch(error => console.error("Error fetching data:", error));
        //     }, 1000); // Sets the interval; controls the speed
        // }
        
        // // Stops the data fetching
        // function stopFetchingData() {
        //     clearInterval(intervalId);
        // }
        
        // // Displays the data inline and using a stackish type (FIFO)
        // function displayData(data) {
        //     const dataContainer = document.getElementById('data-list');
        //     const newDataElement = document.createElement('p');
        //     newDataElement.textContent = `Temperature: ${data.temperature} °C`;
        //     dataContainer.appendChild(newDataElement);
        // }

        var intervalId; // Used to store the interval for polling sensor data

        document.getElementById('startButton').addEventListener('click', function() {
            findAndPollSensors(); // Start polling when clicked
        });

        document.getElementById('stopButton').addEventListener('click', function() {
            if (intervalId) {
                clearInterval(intervalId); // Stop polling
                intervalId = null;
            }
        });

        function findAndPollSensors() {
            const { primary, secondary } = getQueryParams();
            if (!primary || primary === 'None') {
                console.log("No primary sensor selected or sensor is 'None'");
                return;
            }

            // Logic for secondary sensor similar to primary needs implementing

            // Clear existing interval if it exists
            if (intervalId) {
                clearInterval(intervalId);
            }

            // Start new interval for polling
            intervalId = setInterval(() => {
                fetchAndDisplaySensorData(primary, secondary); // Adjusted to pass sensors
            }, 2000); // Poll every 2 seconds, adjust as needed
        }

        // Adjusted to take sensor parameters directly
        function fetchAndDisplaySensorData(primary, secondary) {
            const url = `/get-sensor-data?primary=${primary}&secondary=${secondary}`; // Example URL, adjust as needed
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const dataContainer = document.getElementById('data-list');
                    // Consider clearing previous data or managing how data is appended
                    dataContainer.innerHTML = ''; 
                    const dataElement = document.createElement('p');
                    dataElement.textContent = `Primary: ${data.primary}, Value: ${data.value}`; // Example display, adjust as needed
                    dataContainer.appendChild(dataElement);
                })
                .catch(error => console.error("Error fetching sensor data:", error));
        }

        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                channel: params.get('channel'),
                primary: params.get('primary'),
                secondary: params.get('secondary')
            };
        }
    </script>    
</body>
</html>
